from flask import Flask, request, jsonify
from flask_cors import CORS
import os
import logging

# é…ç½®æ—¥å¿—
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

app = Flask(__name__)
CORS(app)  # å…è®¸æ‰€æœ‰å‰ç«¯åŸŸåè®¿é—®

# æ–‡ç‰©é‰´å®šä¸“ä¸šçŸ¥è¯†åº“
ANTIQUE_KNOWLEDGE = {
    "é’èŠ±ç“·": {
        "æ˜ä»£ç‰¹å¾": "ä½¿ç”¨è‹éº»ç¦»é’æ–™ï¼Œå‘è‰²æµ“è‰³ï¼Œæœ‰é“é”ˆæ–‘ï¼Œçº¹é¥°ç–æœ—å¤§æ°”",
        "æ¸…ä»£ç‰¹å¾": "é‡‡ç”¨æµ™æ–™ï¼Œå‘è‰²çº¯è“ï¼Œçº¹é¥°ç¹å¯†ç²¾ç»†ï¼Œå±‚æ¬¡ä¸°å¯Œ",
        "é‰´å®šè¦ç‚¹": "ä¸€çœ‹é’æ–™å‘è‰²ï¼ŒäºŒè§‚èƒä½“è´¨åœ°ï¼Œä¸‰è¾¨çº¹é¥°é£æ ¼ï¼Œå››è¯†æ¬¾è¯†å¹´ä»£"
    },
    "é’é“œå™¨": {
        "å•†å‘¨ç‰¹å¾": "å½¢åˆ¶å¤æœ´åšé‡ï¼Œçº¹é¥°ç¥ç§˜åº„ä¸¥ï¼Œå¤šé¥•é¤®çº¹ã€äº‘é›·çº¹",
        "æ˜¥ç§‹æˆ˜å›½ç‰¹å¾": "å·¥è‰ºç²¾æ¹›ç»†è…»ï¼Œå‡ºç°å¤±èœ¡æ³•ï¼Œçº¹é¥°æ›´åŠ å†™å®",
        "é‰´å®šè¦ç‚¹": "ä¸€çœ‹é”ˆè‰²å±‚æ¬¡ï¼ŒäºŒå¬æ•²å‡»å£°éŸ³ï¼Œä¸‰è¾¨çº¹é¥°å·¥è‰ºï¼Œå››è¯†é“­æ–‡å†…å®¹"
    },
    "ä¹¦ç”»": {
        "å”ä»£é£æ ¼": "ä»¥äººç‰©ç”»ä¸ºä¸»ï¼Œçº¿æ¡æµç•…æœ‰åŠ›ï¼Œè‰²å½©å¯Œä¸½å ‚çš‡",
        "å®‹ä»£é£æ ¼": "é‡è§†å†™å®æ„å¢ƒï¼Œå±±æ°´ç”»æˆå°±æœ€é«˜ï¼Œè®²ç©¶ç¬”å¢¨éŸµå‘³",
        "é‰´å®šè¦ç‚¹": "ä¸€çœ‹ç¬”å¢¨åŠŸåŠ›ï¼ŒäºŒè§‚çº¸ç»¢æè´¨ï¼Œä¸‰è¯†æ¬¾å°ç‰¹å¾ï¼Œå››è¾¨æ—¶ä»£é£æ ¼"
    },
    "ç‰å™¨": {
        "æ–°çŸ³å™¨æ—¶ä»£": "é€ å‹å¤æœ´ç¥ç§˜ï¼Œå¤šä¸ºç¥­ç¥€ç¤¼å™¨ï¼Œå·¥è‰ºç®€å•ç²—çŠ·",
        "æ˜æ¸…æ—¶æœŸ": "å·¥è‰ºç²¾æ¹›ç»†è…»ï¼Œé¢˜æä¸°å¯Œå¤šæ ·ï¼Œå¤šä¸ºé™ˆè®¾ç©èµ",
        "é‰´å®šè¦ç‚¹": "ä¸€çœ‹ç‰è´¨æ¸©æ¶¦åº¦ï¼ŒäºŒè§‚é›•å·¥ç²¾ç»†åº¦ï¼Œä¸‰è¯†çº¹é¥°æ—¶ä»£æ€§ï¼Œå››è¾¨æ²è‰²è‡ªç„¶åº¦"
    }
}

@app.route('/')
def home():
    """é¦–é¡µæ¬¢è¿ä¿¡æ¯"""
    return jsonify({
        "message": "ğŸ‰ æ–‡é‰´é€šåŠ©æ‰‹Flaskåç«¯APIè¿è¡Œæ­£å¸¸",
        "status": "success",
        "version": "2.0.0",
        "service": "æ–‡ç‰©é‰´å®šä¸“ä¸šAPI"
    })

@app.route('/api/health', methods=['GET'])
def health_check():
    """å¥åº·æ£€æŸ¥ç«¯ç‚¹"""
    return jsonify({
        "status": "healthy",
        "service": "æ–‡é‰´é€šåŠ©æ‰‹Flask API",
        "timestamp": "2024",
        "endpoints": {
            "chat": "/api/chat (POST)",
            "health": "/api/health (GET)"
        }
    })

@app.route('/api/chat', methods=['POST'])
def chat():
    """æ™ºèƒ½æ–‡ç‰©é‰´å®šå¯¹è¯æ¥å£"""
    try:
        # è·å–è¯·æ±‚æ•°æ®
        data = request.get_json()
        if not data:
            return jsonify({
                "reply": "è¯·æä¾›æœ‰æ•ˆçš„JSONæ•°æ®",
                "status": "error"
            }), 400
            
        user_message = data.get('message', '').strip()
        user_id = data.get('user_id', 'anonymous')
        
        if not user_message:
            return jsonify({
                "reply": "è¯·è¾“å…¥æ‚¨è¦å’¨è¯¢çš„æ–‡ç‰©é—®é¢˜",
                "status": "error"
            }), 400
        
        logger.info(f"ç”¨æˆ· {user_id} å’¨è¯¢: {user_message}")
        
        # æ™ºèƒ½å›å¤é€»è¾‘
        user_message_lower = user_message.lower()
        
        if any(keyword in user_message_lower for keyword in ["é’èŠ±ç“·", "ç“·å™¨", "é™¶ç“·"]):
            knowledge = ANTIQUE_KNOWLEDGE["é’èŠ±ç“·"]
            reply = "ğŸº **é’èŠ±ç“·ä¸“ä¸šé‰´å®šæŒ‡å—**\n\n"
            for key, value in knowledge.items():
                reply += f"**{key}**: {value}\n"
            reply += "\nğŸ’¡ **æ¸©é¦¨æç¤º**: é’èŠ±ç“·é‰´å®šéœ€è¦ç»“åˆå®ç‰©è§‚å¯Ÿï¼Œå»ºè®®æ‰¾ä¸“ä¸šæœºæ„æ£€æµ‹ã€‚"
            
        elif any(keyword in user_message_lower for keyword in ["é’é“œ", "é“œå™¨", "é’é“œå™¨"]):
            knowledge = ANTIQUE_KNOWLEDGE["é’é“œå™¨"]
            reply = "âš±ï¸ **é’é“œå™¨ä¸“ä¸šé‰´å®šæŒ‡å—**\n\n"
            for key, value in knowledge.items():
                reply += f"**{key}**: {value}\n"
            reply += "\nğŸ’¡ **æ¸©é¦¨æç¤º**: é’é“œå™¨é‰´å®šè¦æ³¨æ„é”ˆè‰²çš„è‡ªç„¶ç¨‹åº¦å’Œé“¸é€ å·¥è‰ºã€‚"
            
        elif any(keyword in user_message_lower for keyword in ["ä¹¦ç”»", "å­—ç”»", "ç»˜ç”»", "å›½ç”»"]):
            knowledge = ANTIQUE_KNOWLEDGE["ä¹¦ç”»"]
            reply = "ğŸ–¼ï¸ **ä¹¦ç”»ä¸“ä¸šé‰´å®šæŒ‡å—**\n\n"
            for key, value in knowledge.items():
                reply += f"**{key}**: {value}\n"
            reply += "\nğŸ’¡ **æ¸©é¦¨æç¤º**: ä¹¦ç”»é‰´å®šéœ€è¦ä¸°å¯Œçš„ç»éªŒå’Œä¸“ä¸šçŸ¥è¯†ï¼Œå»ºè®®å¤šæ–¹æ±‚è¯ã€‚"
            
        elif any(keyword in user_message_lower for keyword in ["ç‰å™¨", "ç‰çŸ³", "ç‰é›•", "å¤ç‰"]):
            knowledge = ANTIQUE_KNOWLEDGE["ç‰å™¨"]
            reply = "ğŸ’ **ç‰å™¨ä¸“ä¸šé‰´å®šæŒ‡å—**\n\n"
            for key, value in knowledge.items():
                reply += f"**{key}**: {value}\n"
            reply += "\nğŸ’¡ **æ¸©é¦¨æç¤º**: ç‰å™¨é‰´å®šè¦æ³¨æ„æè´¨ã€å·¥è‰ºå’Œæ²è‰²çš„è‡ªç„¶å˜åŒ–ã€‚"
            
        elif any(keyword in user_message_lower for keyword in ["é‰´å®š", "çœŸä¼ª", "çœŸå‡", "é‰´åˆ«", "è¯„ä¼°"]):
            reply = """ğŸ” **æ–‡ç‰©é‰´å®šç»¼åˆæŒ‡å—**

**é‰´å®šäº”å¤§è¦ç´ **:
1ï¸âƒ£ **æè´¨åˆ†æ** - é€šè¿‡ç§‘å­¦ä»ªå™¨æ£€æµ‹ææ–™æˆåˆ†å’Œå¹´ä»£
2ï¸âƒ£ **å·¥è‰ºç‰¹å¾** - è§‚å¯Ÿåˆ¶ä½œå·¥è‰ºæ˜¯å¦ç¬¦åˆæ—¶ä»£ç‰¹ç‚¹
3ï¸âƒ£ **è‰ºæœ¯é£æ ¼** - å¯¹æ¯”åŒæ—¶æœŸåŒç±»æ–‡ç‰©çš„è‰ºæœ¯ç‰¹å¾
4ï¸âƒ£ **æ¬¾è¯†è€ƒè¯** - ç ”ç©¶æ¬¾è¯†ã€é“­æ–‡çš„æ—¶ä»£ç‰¹å¾å’Œå†…å®¹
5ï¸âƒ£ **ä¼ æ‰¿è„‰ç»œ** - äº†è§£æ–‡ç‰©çš„æ”¶è—å†å²å’Œæµä¼ ç»å†

**å»ºè®®æ­¥éª¤**:
â€¢ æä¾›æ¸…æ™°çš„å¤šè§’åº¦ç…§ç‰‡
â€¢ æè¿°æ–‡ç‰©çš„å…·ä½“å°ºå¯¸å’Œé‡é‡
â€¢ è¯´æ˜è·å¾—é€”å¾„å’Œå·²çŸ¥å†å²
â€¢ å¿…è¦æ—¶å¯»æ±‚ä¸“ä¸šæ£€æµ‹æœºæ„å¸®åŠ©

ğŸ’ **ä¸“ä¸šå»ºè®®**: çè´µæ–‡ç‰©å»ºè®®æ‰¾å›½å®¶è®¤å¯çš„é‰´å®šæœºæ„è¿›è¡Œç§‘å­¦æ£€æµ‹ã€‚"""
            
        elif any(keyword in user_message_lower for keyword in ["ä½ å¥½", "æ‚¨å¥½", "hello", "hi"]):
            reply = "ğŸ‘‹ æ‚¨å¥½ï¼æˆ‘æ˜¯æ–‡é‰´é€šåŠ©æ‰‹ï¼Œä¸“æ³¨äºæ–‡ç‰©é‰´å®šçš„ä¸“ä¸šAIåŠ©æ‰‹ã€‚æˆ‘å¯ä»¥ä¸ºæ‚¨æä¾›ï¼š\n\nâ€¢ ğŸº é™¶ç“·ç±»æ–‡ç‰©é‰´å®š\nâ€¢ âš±ï¸ é’é“œå™¨é‰´å®š  \nâ€¢ ğŸ–¼ï¸ ä¹¦ç”»ç±»é‰´å®š\nâ€¢ ğŸ’ ç‰å™¨ç±»é‰´å®š\nâ€¢ ğŸ” ç»¼åˆé‰´å®šæ–¹æ³•\n\nè¯·å‘Šè¯‰æˆ‘æ‚¨æƒ³äº†è§£çš„å…·ä½“æ–‡ç‰©ç±»å‹æˆ–é‰´å®šé—®é¢˜ï¼"
            
        elif any(keyword in user_message_lower for keyword in ["è°¢è°¢", "æ„Ÿè°¢", "thank"]):
            reply = "ğŸ™ ä¸å®¢æ°”ï¼èƒ½ä¸ºæ‚¨æä¾›æ–‡ç‰©é‰´å®šæ–¹é¢çš„å¸®åŠ©æ˜¯æˆ‘çš„è£å¹¸ã€‚å¦‚æœæ‚¨è¿˜æœ‰å…¶ä»–é—®é¢˜ï¼Œéšæ—¶æ¬¢è¿å’¨è¯¢ï¼"
            
        else:
            reply = """ğŸ¤” **æ–‡ç‰©é‰´å®šå’¨è¯¢**

æˆ‘ä¸»è¦æ“…é•¿ä»¥ä¸‹æ–‡ç‰©ç±»å‹çš„é‰´å®šå’¨è¯¢ï¼š

**ğŸº é™¶ç“·ç±»**
â€¢ é’èŠ±ç“·å¹´ä»£é‰´å®š
â€¢ å½©ç“·çœŸä¼ªè¾¨åˆ«
â€¢ é™¶å™¨å·¥è‰ºåˆ†æ

**âš±ï¸ é‡‘å±ç±»**  
â€¢ é’é“œå™¨æ—¶ä»£åˆ¤æ–­
â€¢ é“œå™¨å·¥è‰ºç‰¹å¾
â€¢ é‡‘é“¶å™¨æè´¨é‰´å®š

**ğŸ–¼ï¸ ä¹¦ç”»ç±»**
â€¢ å­—ç”»å¹´ä»£åˆ¤æ–­
â€¢ ç”»å®¶é£æ ¼è¯†åˆ«
â€¢ çº¸è´¨æè´¨åˆ†æ

**ğŸ’ ç‰å™¨ç±»**
â€¢ ç‰æè´¨åœ°é‰´å®š
â€¢ é›•å·¥æ—¶ä»£ç‰¹å¾
â€¢ æ²è‰²è‡ªç„¶åˆ¤æ–­

**ğŸ” è¯·å…·ä½“æè¿°**ï¼š
æ‚¨æƒ³é‰´å®šçš„æ–‡ç‰©ç±»å‹ã€ç‰¹å¾å’Œå…·ä½“é—®é¢˜ï¼Œæˆ‘ä¼šç»™æ‚¨ä¸“ä¸šçš„è§£ç­”ï¼"""

        logger.info(f"å›å¤ç”¨æˆ· {user_id}: {reply[:100]}...")
        
        return jsonify({
            "reply": reply,
            "status": "success",
            "user_id": user_id,
            "timestamp": "2024"
        })
        
    except Exception as e:
        logger.error(f"å¤„ç†æ¶ˆæ¯æ—¶å‡ºé”™: {str(e)}")
        return jsonify({
            "reply": "âŒ æŠ±æ­‰ï¼ŒæœåŠ¡æš‚æ—¶é‡åˆ°é—®é¢˜ï¼Œè¯·ç¨åé‡è¯•ã€‚",
            "status": "error",
            "error": str(e)
        }), 500

# é”™è¯¯å¤„ç†
@app.errorhandler(404)
def not_found(error):
    return jsonify({
        "error": "æ¥å£ä¸å­˜åœ¨",
        "status": "error"
    }), 404

@app.errorhandler(500)
def internal_error(error):
    return jsonify({
        "error": "æœåŠ¡å™¨å†…éƒ¨é”™è¯¯",
        "status": "error"
    }), 500

if __name__ == '__main__':
    port = int(os.environ.get('PORT', 5000))
    app.run(host='0.0.0.0', port=port, debug=False)